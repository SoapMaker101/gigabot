# GigaBot v0.5 — План

## Контекст

GigaBot v0.4 — AI-агент на базе GigaChat-2-Max, Telegram.
Сервер: Ubuntu 22.04, Python 3.11, user=gigabot, path=~/gigabot

## Результаты v0.4 (25.02.2026)

### Работает (16/22):
- Диалог, создание проектов, список проектов и подпапок
- Веб-поиск (Brave)
- Чтение PDF/DOCX файлов из Telegram
- SaluteSpeech STT (голос → текст)
- Shell exec (df -h)
- Добавление подпапок (project add_folder)
- Задачи (tasks add/list)
- Напоминания (cron)
- Kandinsky (generate_image)
- **Move файла в проект** — project(move_file) с auto-fill file_path ✓
- **Создание файла + отправка** (когда content указан) ✓
- **База знаний create/list** ✓
- **Чтение PDF** через pdfplumber ✓
- **Anti-loop** (3 вызова → стоп) ✓

### Не работает (6/22):

#### ПРОБЛЕМА 1: Отправка файлов из проекта (P0 — главная фича)

**Симптом:** "Пришли файл из Тест/Сметы" → модель вызывает file(read) вместо message(media=[путь]).
Модель ЧИТАЕТ файл (получает содержимое PDF), но НЕ отправляет его пользователю.

**Корневая причина:** GigaChat не понимает разницу между "прочитай файл" и "отправь файл".
Также: модель не знает что message tool может отправлять файлы по пути.

**Решение (2 уровня):**
1. **Новый action в project tool**: `project(action="send_files", name="Тест", folder_name="Сметы")` — tool сам находит файлы и вызывает message(media=[...]) 
2. **Промпт**: "Когда пользователь просит ПРИСЛАТЬ/ОТПРАВИТЬ файл — НЕ читай его, а вызови message(media=[путь_к_файлу])"

**Файлы:** `filesystem.py`, `context.py`, возможно `loop.py` (auto-dispatch)

#### ПРОБЛЕМА 2: "Создай файл и отправь" без содержания (P1)

**Симптом:** Зацикливается — file(write, path="hello.txt") без content × 3 → loop → стоп.
Промпт говорит "спроси содержание", но модель игнорирует.

**Корневая причина:** GigaChat видит "создай и отправь" как одну операцию и пытается выполнить сразу, не останавливаясь на вопрос.

**Решение:** Auto-fill content в loop.py. Если file(write) вызван без content — вернуть ошибку которая ЗАСТАВИТ модель спросить:
"СТОП: content не указан. Ты ДОЛЖЕН спросить у пользователя что записать в файл. Ответь текстом с вопросом."

**Файлы:** `loop.py` или `filesystem.py`

#### ПРОБЛЕМА 3: RAG не протестирован (P1)

**Что проверить:**
- knowledge(index_file) — добавление PDF в базу знаний
- knowledge(search) — поиск по документам
- Интеграция: "добавь PDF в базу → найди в базе информацию по X"

**Файлы:** `rag.py` (если найдутся баги)

#### ПРОБЛЕМА 4: readability-lxml на сервере (P2)

**Симптом:** `pip show readability-lxml` показывает что установлен, но `import` падает.

**Диагностика:**
```bash
python -c "from readability import Document; print('OK')"
```

**Файлы:** серверная проблема, не код

## Приоритеты v0.5

| # | Задача | Файлы | Приоритет |
|---|--------|-------|-----------|
| 1 | project(send_files) — отправка файлов из проекта | filesystem.py, context.py | P0 |
| 2 | Промпт: "отправь файл" ≠ "прочитай файл" | context.py | P0 |
| 3 | file(write) без content — принудительный вопрос | filesystem.py или loop.py | P1 |
| 4 | Тест RAG (index + search) | rag.py | P1 |
| 5 | readability-lxml на сервере | серверная задача | P2 |

## Тесты после v0.5

| # | Тест | Ожидание |
|---|------|----------|
| 1 | "Пришли файлы из Тест/Сметы" | Получаю PDF в Telegram |
| 2 | "Пришли все файлы из Тест" | Получаю файлы из всех подпапок |
| 3 | "Создай файл и отправь" (без содержания) | Спросит что записать |
| 4 | Отправить PDF + "Добавь в базу знаний test" | knowledge(index_file) → OK |
| 5 | "Найди в базе test информацию о люках" | knowledge(search) → релевантные фрагменты |

## Деплой

```bash
cd ~/gigabot && git pull origin main && pip install -e . && sudo systemctl restart gigabot
sudo journalctl -u gigabot -f
```
