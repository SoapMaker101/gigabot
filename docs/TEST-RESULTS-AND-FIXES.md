# Результаты тестирования GigaBot v0.1.0 — 24.02.2026

## Сводка

| # | Тест | Результат | Проблема |
|---|------|-----------|----------|
| 1 | Базовый диалог | ✅ OK | — |
| 2 | Создание папки проекта | ✅ OK | — |
| 3 | Список проектов | ✅ OK | — |
| 4 | Поиск в интернете | ✅ OK | — |
| 5 | web_fetch (открытие URL) | ❌ FAIL | GigaChat не вызывает `web_fetch`, отвечает "не могу открывать сайты" |
| 6 | OCR (фото с текстом) | ✅ OK | Чек распознан |
| 7 | OCR (фото без текста) | ✅ OK | Корректно сообщает "текст не найден" |
| 8 | Голосовое сообщение (STT) | ❌ FAIL | SaluteSpeech 401 Unauthorized |
| 9 | Отправка файла в Telegram | ❌ FAIL | Файл не создаётся перед отправкой (write_file не вызывается) |
| 10 | Создание DOCX | ❌ FAIL | Аналогично — message вызван без предварительного write_file |
| 11 | Чтение DOCX из Telegram | ✅ OK | read_file корректно прочитал содержимое |
| 12 | Перемещение файла в проект | ❌ FAIL | GigaChat "не видит" move_file, говорит "нет инструмента" |
| 13 | Создание задачи | ⚠️ ЧАСТИЧНО | GigaChat ответил текстом, но `tasks` tool не вызван |
| 14 | Список задач | ⚠️ ЧАСТИЧНО | tasks вызван, но "нет задач" — задача из теста 13 не была сохранена |
| 15 | RAG: создание базы знаний | ❌ FAIL | Вместо `rag` вызван `create_project` — путает RAG-проект с папкой проекта |
| 16 | RAG: индексация PDF | ❌ FAIL | Ошибка чтения PDF (pdfplumber не установлен?) |
| 17 | RAG: индексация DOC | ❌ FAIL | .doc не поддерживается (только .docx) |
| 18 | RAG: поиск | ❌ FAIL | "Collection does not exist" — RAG-проект не был создан через rag tool |
| 19 | Генерация изображения | ❌ FAIL | generate_image вызван, но картинка не пришла — только текстовое описание |
| 20 | Напоминание (cron) | ❌ FAIL | GigaChat ответил текстом, cron tool не вызван |
| 21 | Shell (df -h) | ❌ FAIL | exec tool не вызван, GigaChat дал текстовую инструкцию |
| 22 | Добавление подпапки в проект | ⚠️ ЧАСТИЧНО | Зацикливание (20 итераций list_dir/list_projects), нет mkdir tool |
| 23 | Удаление подпапки | ✅ OK | Сработало (но как — из логов не видно, видимо через exec) |
| 24 | /new | ✅ OK | Сессия сброшена |
| 25 | /help | не тестировался | — |
| 26 | Memory consolidation | ⚠️ | Последняя консолидация: "LLM did not call save_memory" |

---

## Анализ проблем и план исправлений

### ПРОБЛЕМА 1: SaluteSpeech 401 Unauthorized (КРИТИЧНО)

**Лог:**
```
Failed to obtain SaluteSpeech token: Client error '401 Unauthorized'
for url 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth'
```

**Причина:** Авторизация на SaluteSpeech OAuth не проходит. Возможные варианты:
1. Неверные `client_id` / `client_secret` в config.json
2. Неверный `scope` (должен быть `SALUTE_SPEECH_PERS`)
3. Формат авторизации: SaluteSpeech может требовать base64-encoded credentials в заголовке Authorization вместо HTTP Basic Auth

**Последствия:** Все голосовые сообщения не транскрибируются. Агент получает `[voice: path.ogg]` и не понимает что с этим делать — начинает гуглить "конвертер ogg".

**План исправления:**
- Проверить документацию SaluteSpeech OAuth — формат запроса может отличаться от нашей реализации
- Возможно нужен `Authorization: Basic base64(client_id:client_secret)` в заголовке вместо `auth=(client_id, client_secret)` в httpx

**Вопрос:** У тебя credentials от SaluteSpeech получены в том же проекте, что и GigaChat? Или это отдельный проект на developers.sber.ru?

---

### ПРОБЛЕМА 2: GigaChat не вызывает многие tools (КРИТИЧНО)

**Симптом:** GigaChat "не видит" или не хочет вызывать: `web_fetch`, `move_file`, `exec`, `cron`, `tasks`, `voice_note`.

**Лог-примеры:**
- "Перемести файл" → `list_projects` (без `move_file`)
- "Напомни через 2 минуты" → текстовый ответ (без `cron`)
- "Покажи место на диске" → текстовый ответ (без `exec`)
- "Создай задачу" → текстовый ответ (без `tasks`)

**Причина:** GigaChat получает список из 17+ functions одновременно. У GigaChat-2-Max есть лимит на количество функций, которые модель может обработать (обычно 8-12 функций). При перегрузке модель игнорирует часть tools или путается.

**План исправления:**
- Сократить описания функций до минимума (убрать лишние слова)
- Объединить похожие tools (например, `list_projects` и `create_project` → один `project` tool с action)
- Улучшить system prompt: явно перечислить доступные инструменты
- Как вариант: разделить tools на группы и подключать по контексту

**Вопрос:** Предпочитаешь объединить tools в меньшее количество "мульти-action" инструментов (как `rag` и `tasks`), или оставить отдельные tools но ограничить набор?

---

### ПРОБЛЕМА 3: Файлы не создаются перед отправкой (СРЕДНЕ)

**Лог:**
```
Tool call: message({"content": "Создал файл заметка.txt...", "media": ["заметка.txt"]})
Failed to send media: No such file or directory: '.../заметка.txt'
```

**Причина:** GigaChat вызывает сразу `message` с `media`, но не вызывает `write_file` предварительно. Файл не существует на диске.

**План исправления:**
- Усилить system prompt: "ВСЕГДА сначала создай файл через write_file, затем отправь через message"
- Добавить проверку в `MessageTool.execute()`: если media-файл не существует — вернуть ошибку "файл не найден, сначала создай его через write_file"

---

### ПРОБЛЕМА 4: RAG путается с папками проектов (СРЕДНЕ)

**Лог:**
```
"Создай базу знаний строительство" → create_project("строительство")  // НЕПРАВИЛЬНО
"Добавь файл в базу знаний" → rag(action="index_file")  // правильно
"Поиск в базе знаний" → rag(action="search") → "Collection does not exist"
```

**Причина:** Слова "создай" + "проект/базу" вызывают `create_project` вместо `rag`. RAG-коллекция в ChromaDB не создана.

**План исправления:**
- Переименовать RAG tool: `rag` → `knowledge_base` (более понятно для модели)
- Улучшить description RAG tool: "Работа с базами знаний для поиска по документам"
- Переименовать `create_project` → `project_folder` чтобы различать

---

### ПРОБЛЕМА 5: PDF/DOC не читается в RAG (СРЕДНЕ)

**Лог:**
```
rag(action="index_file", file_path="...СП124.pdf") → ошибка чтения PDF
rag(action="index_file", file_path="...ГОСТ.doc") → ошибка
```

**Причина:** 
1. PDF: pdfplumber может быть не установлен в venv, или файл повреждён
2. DOC: формат .doc (старый Word) не поддерживается python-docx (только .docx)

**План исправления:**
- Проверить `pip install pdfplumber` в venv
- Добавить поддержку .doc через `antiword` или `textract`
- Или конвертировать .doc → .docx через libreoffice: `libreoffice --convert-to docx file.doc`

**Вопрос:** Будешь часто загружать .doc файлы (старый Word)? Или в основном .docx и .pdf?

---

### ПРОБЛЕМА 6: Kandinsky не генерирует изображения (СРЕДНЕ)

**Лог:**
```
Tool call: generate_image({"prompt": "двухэтажный коттедж с красной крышей"})
Response: "Вот описание коттеджа..." (текст вместо картинки)
```

**Причина:** В текущей реализации `KandinskyTool` отправляет запрос в GigaChat, но не получает `file_id` от встроенной функции `text2image`. Нужно корректно использовать GigaChat API для генерации изображений.

**План исправления:**
По документации GigaChat, для генерации изображений нужно:
1. Отправить запрос с `"function_call": "auto"` без массива `functions`
2. В ответе получить `<img src="file_id"/>` в content
3. Скачать изображение через `get_image(file_id)`
4. Сохранить и отправить

Текущий `KandinskyTool` отправляет запрос с функциями агента, что мешает встроенной функции `text2image`. Нужно делать отдельный вызов GigaChat API без пользовательских функций.

---

### ПРОБЛЕМА 7: Зацикливание при неизвестном действии (НИЗКО)

**Лог (добавление подпапки "Контакты"):**
```
19:38:11 Tool call: create_project("Дом на Ленина")
19:38:15 Tool call: list_dir(...)
19:38:16 Tool call: list_dir(...)
19:38:19 Tool call: list_dir(...)
...повторяется 20 раз...
19:39:14 Response: "I've completed processing but have no response to give."
```

**Причина:** Нет инструмента `mkdir` (создать подпапку). Агент зацикливается пытаясь найти способ.

**План исправления:**
- Добавить tool `mkdir` или расширить `create_project` параметром `subfolder`
- Или разрешить `exec` для создания папок и улучшить prompt

---

### ПРОБЛЕМА 8: Memory consolidation сбой (НИЗКО)

**Лог:**
```
Memory consolidation: LLM did not call save_memory
```

**Причина:** GigaChat при консолидации памяти не вызвал `save_memory` tool. Скорее всего перегружен контекст (38 сообщений + tools).

**План исправления:**
- Консолидацию делать без tools (простой текстовый промпт) — GigaChat возвращает JSON-строку вместо tool call
- Или уменьшить контекст при консолидации

---

## Приоритеты

| Приоритет | Проблема | Влияние |
|-----------|----------|---------|
| P0 | #2 GigaChat не вызывает tools | Блокирует 7+ функций |
| P0 | #1 SaluteSpeech 401 | Блокирует голосовые |
| P1 | #3 Файлы не создаются | Блокирует создание документов |
| P1 | #4 RAG путает с проектами | Блокирует RAG |
| P1 | #6 Kandinsky не работает | Блокирует генерацию |
| P2 | #5 PDF/DOC не читается | Ограничивает RAG |
| P2 | #7 Зацикливание | UX проблема |
| P3 | #8 Memory consolidation | Некритично |

## Вопросы

1. **SaluteSpeech**: credentials от того же проекта на developers.sber.ru что и GigaChat? Можешь проверить авторизацию через curl?
2. **Tools**: предпочитаешь объединить tools (меньше инструментов, но с actions), или оставить отдельные?
3. **DOC**: часто будут .doc файлы (старый Word) или можно ограничиться .docx?
4. **Exec**: разрешаем агенту выполнять shell-команды (df, mkdir и т.д.) или это слишком рискованно?
