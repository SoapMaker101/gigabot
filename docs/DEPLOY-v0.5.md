# GigaBot v0.5 — Деплой и тесты

## Что сделано в v0.5

1. **project(send_files)** — новый action в `project`: по имени проекта и опционально папке возвращает пути файлов и явную инструкцию вызвать `message(media=[...])` для отправки пользователю.
2. **Промпт** — в системном контексте добавлено правило: «пришли/отправь файл» → не `file(read)`, а `project(send_files)` + `message(media=[...])` (ПРАВИЛО 2.1 и блок про вложенные файлы).
3. **file(write) без content** — при пустом `content` возвращается жёсткая ошибка с требованием спросить у пользователя, что записать, и не вызывать `file(write)` повторно без content.
4. **RAG** — без изменений кода; пути к файлам из Telegram по-прежнему подставляются в `knowledge(index_file)` через патч в loop. При необходимости ограничения путей workspace — отдельная задача.

---

## Команды для деплоя

Сервер: Ubuntu 22.04, пользователь `gigabot`, каталог `~/gigabot`.

### 1. Подключение и переход в каталог

```bash
ssh gigabot@<адрес_сервера>
cd ~/gigabot
```

### 2. Обновление кода

```bash
git fetch origin
git checkout main
git pull origin main
```

### 3. Установка зависимостей

Если используется виртуальное окружение:

```bash
source .venv/bin/activate   # или путь к вашему venv
pip install -e .
```

Если установка в систему от пользователя gigabot:

```bash
pip install -e . --user
```

Или глобально (если так принято на сервере):

```bash
pip install -e .
```

### 4. Перезапуск сервиса

```bash
sudo systemctl restart gigabot
```

### 5. Проверка логов

```bash
sudo journalctl -u gigabot -f
```

Убедиться, что сервис поднялся без ошибок (например, сообщение о старте бота и подключении к Telegram).

### Одной строкой (после cd ~/gigabot)

```bash
git pull origin main && pip install -e . && sudo systemctl restart gigabot && sudo journalctl -u gigabot -f
```

---

## Тесты после деплоя

Прогнать в Telegram (или в том канале, где запущен бот).

| # | Действие | Ожидание |
|---|----------|----------|
| **1** | Написать: **«Пришли файлы из Тест/Сметы»** (проект «Тест», папка «Сметы» должны существовать и содержать файлы) | Бот вызывает `project(send_files)` и затем `message(media=[...])`; в чат приходят файлы (например PDF). |
| **2** | Написать: **«Пришли все файлы из Тест»** (проект «Тест» с подпапками и файлами) | Бот присылает файлы из всех подпапок проекта. |
| **3** | Написать: **«Создай файл и отправь»** без указания имени/содержимого | Бот спрашивает, что записать в файл (не зацикливается на `file(write)` без content). |
| **4** | Отправить боту **PDF-файл** и написать: **«Добавь в базу знаний test»** | Выполняется `knowledge(index_file, project='test', file_path=<путь к скачанному файлу>)`; в ответе — что файл проиндексирован, указано число фрагментов. |
| **5** | Написать: **«Найди в базе test информацию о люках»** (или другой запрос по содержимому добавленного PDF) | Выполняется `knowledge(search, project='test', query='...')`; в ответе — релевантные фрагменты с указанием источника. |

### Подготовка к тестам 1–2

- Создать проект и папку, если ещё нет: в чате написать «Создай проект Тест» (или использовать существующий).
- «Добавь в проект Тест папку Сметы» → project(add_folder).
- Положить файлы в проект: отправить файл в Telegram и написать «Перемести этот файл в проект Тест в папку Сметы» (или положить файлы на сервер в `~/gigabot/workspace/projects/Тест/Сметы/`).

### Подготовка к тестам 4–5

- «Создай базу знаний test» → knowledge(create_project, project='test').
- Дальше — по шагам 4 и 5 таблицы выше.

---

## Откат (если потребуется)

```bash
cd ~/gigabot
git log -1 --oneline   # запомнить хеш текущего коммита
git checkout <предыдущий_коммит>
pip install -e .
sudo systemctl restart gigabot
```

---

## Краткий чек-лист деплоя

- [ ] `git pull origin main`
- [ ] `pip install -e .`
- [ ] `sudo systemctl restart gigabot`
- [ ] `journalctl -u gigabot -f` — нет ошибок при старте
- [ ] Тест 1: «Пришли файлы из Тест/Сметы»
- [ ] Тест 2: «Пришли все файлы из Тест»
- [ ] Тест 3: «Создай файл и отправь» → спрашивает содержание
- [ ] Тест 4: PDF + «Добавь в базу знаний test»
- [ ] Тест 5: «Найди в базе test информацию о …»
